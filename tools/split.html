<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Split PDF ‚Äî PDF Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/ui.css">
  <style>
    :root{ --bg:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; }
    html,body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif; }
    .wrap{ max-width:900px; margin:24px auto; padding:0 16px; }
    .card{ background:#0f172a; border:1px solid var(--border); border-radius:14px; padding:16px; margin:12px 0; }
    .card h2{ margin:0 0 12px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; }
    
    /* Range list */
    .range-list{ list-style:none; padding:0; margin:12px 0; }
    .range-list li{ 
      display:flex; align-items:center; gap:10px; padding:10px 12px; 
      background:#111827; border:1px solid var(--border); border-radius:10px; margin:6px 0;
    }
    .range-list li:hover{ background:#1e293b; }
    .range-list li input[type="text"]{ 
      flex:1; background:#0f172a; border:1px solid var(--border); 
      color:var(--text); padding:8px 10px; border-radius:8px; font-size:14px;
    }
    .range-list li input[type="text"]:focus{ outline:2px solid #3b82f6; border-color:transparent; }
    .range-list li .remove{ 
      background:#7f1d1d; border:none; color:#fecaca; padding:6px 10px; 
      border-radius:6px; cursor:pointer; font-size:14px;
    }
    .range-list li .remove:hover{ background:#991b1b; }
    
    /* Drop zone */
    .drop-zone{ 
      border:2px dashed var(--border); border-radius:12px; padding:32px; 
      text-align:center; margin:12px 0; transition:border-color 0.2s, background 0.2s;
    }
    .drop-zone.drag-over{ border-color:#3b82f6; background:rgba(59,130,246,0.1); }
    .drop-zone p{ margin:8px 0; }
    .drop-zone.loaded{ border-style:solid; border-color:#22c55e; background:rgba(34,197,94,0.1); }
    
    /* Progress */
    .progress-bar{ height:8px; background:#1e293b; border-radius:4px; overflow:hidden; margin:12px 0; }
    .progress-bar .fill{ height:100%; background:linear-gradient(90deg, #3b82f6, #60a5fa); width:0%; transition:width 0.3s; }
    
    /* Buttons */
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
    .btn-primary{ background:linear-gradient(180deg, #2563eb, #1e40af); border-color:rgba(37,99,235,.6); }
    .btn-secondary{ background:linear-gradient(180deg, #374151, #1f2937); }
    
    /* Preset buttons */
    .presets{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .presets button{ font-size:13px; padding:6px 12px; }
  </style>
</head>
<body>
<header class="topnav">
  <div class="brand">PDF Editor ‚Äî Split</div>
  <nav>
    <a href="/index.html">Editor</a>
    <a href="/tools/merge.html">Merge</a>
    <a href="/tools/crop.html">Crop</a>
    <a href="/tools/convert.html">Convert</a>
    <a href="/help.html">Help</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <h2>‚úÇÔ∏è Split PDF by Page Ranges</h2>
    <p class="muted">Extract specific pages or page ranges from a PDF into separate files.</p>
    
    <div class="drop-zone" id="dropZone">
      <p><strong id="dropLabel">üìÅ Drop a PDF file here</strong></p>
      <p class="muted">or</p>
      <input type="file" id="fileInput" accept="application/pdf" style="display:none">
      <button id="selectBtn">Select PDF File</button>
    </div>
    
    <div id="rangeSection" style="display:none">
      <h3 style="margin:16px 0 8px; font-size:16px;">Define Page Ranges</h3>
      <p class="muted">Enter page ranges like "1-3", "5", or "7-10". Each range will be exported as a separate PDF.</p>
      
      <div class="presets">
        <button id="presetAll">All Pages (one each)</button>
        <button id="presetHalves">Split in Half</button>
        <button id="presetOddEven">Odd/Even Pages</button>
      </div>
      
      <ul class="range-list" id="rangeList"></ul>
      
      <button id="addRangeBtn" class="btn-secondary">+ Add Range</button>
    </div>
    
    <div class="progress-bar" id="progressBar" style="display:none">
      <div class="fill" id="progressFill"></div>
    </div>
    <p id="statusText" class="muted" style="display:none"></p>
    
    <div class="actions">
      <button id="splitBtn" class="btn-primary" disabled>Split & Download</button>
      <button id="clearBtn">Clear</button>
    </div>
  </div>
  
  <div class="card">
    <h2>üí° Tips</h2>
    <ul class="muted">
      <li>Use ranges like "1-5" for pages 1 through 5</li>
      <li>Use single numbers like "3" for just one page</li>
      <li>Use "1,3,5" to select multiple individual pages in one file</li>
      <li>Each range becomes a separate PDF file</li>
      <li>Processing happens entirely in your browser</li>
    </ul>
  </div>
</div>

<!-- pdf-lib (self-hosted) -->
<script src="/vendor/pdf-lib.min.js"></script>

<script>
const { PDFDocument } = PDFLib;

// DOM elements
const dropZone = document.getElementById('dropZone');
const dropLabel = document.getElementById('dropLabel');
const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
const rangeSection = document.getElementById('rangeSection');
const rangeList = document.getElementById('rangeList');
const addRangeBtn = document.getElementById('addRangeBtn');
const splitBtn = document.getElementById('splitBtn');
const clearBtn = document.getElementById('clearBtn');
const progressBar = document.getElementById('progressBar');
const progressFill = document.getElementById('progressFill');
const statusText = document.getElementById('statusText');

// Preset buttons
const presetAll = document.getElementById('presetAll');
const presetHalves = document.getElementById('presetHalves');
const presetOddEven = document.getElementById('presetOddEven');

// State
let pdfData = null;
let pdfDoc = null;
let pageCount = 0;
let ranges = [];

// Helpers
function updateProgress(percent, text) {
  progressBar.style.display = 'block';
  progressFill.style.width = percent + '%';
  if (text) {
    statusText.style.display = 'block';
    statusText.textContent = text;
  }
}

function hideProgress() {
  progressBar.style.display = 'none';
  statusText.style.display = 'none';
  progressFill.style.width = '0%';
}

function parseRange(rangeStr, maxPage) {
  // Parse a range string like "1-5" or "3" or "1,3,5-7" into an array of page indices (0-based)
  const pages = new Set();
  const parts = rangeStr.split(',').map(s => s.trim()).filter(s => s);
  
  for (const part of parts) {
    if (part.includes('-')) {
      const [start, end] = part.split('-').map(s => parseInt(s.trim(), 10));
      if (isNaN(start) || isNaN(end)) continue;
      for (let i = Math.max(1, start); i <= Math.min(maxPage, end); i++) {
        pages.add(i - 1); // 0-based
      }
    } else {
      const num = parseInt(part, 10);
      if (!isNaN(num) && num >= 1 && num <= maxPage) {
        pages.add(num - 1);
      }
    }
  }
  
  return Array.from(pages).sort((a, b) => a - b);
}

function addRange(value = '') {
  const index = ranges.length;
  ranges.push(value);
  
  const li = document.createElement('li');
  li.innerHTML = `
    <span style="color:var(--muted)">#${index + 1}</span>
    <input type="text" value="${value}" placeholder="e.g., 1-5 or 3,7,9-12" data-index="${index}">
    <button class="remove" data-index="${index}">‚úï</button>
  `;
  rangeList.appendChild(li);
  
  // Focus the new input
  const input = li.querySelector('input');
  input.focus();
  
  // Update range on change
  input.addEventListener('input', (e) => {
    ranges[parseInt(e.target.dataset.index, 10)] = e.target.value;
    updateSplitButton();
  });
  
  // Remove button
  li.querySelector('.remove').addEventListener('click', (e) => {
    li.remove();
    // Rebuild ranges array from remaining DOM elements
    ranges = [];
    rangeList.querySelectorAll('input[data-index]').forEach((input, i) => {
      ranges.push(input.value);
      input.dataset.index = i;
      input.closest('li').querySelector('.remove').dataset.index = i;
      input.closest('li').querySelector('span:first-child').textContent = `#${i + 1}`;
    });
    updateSplitButton();
  });
  
  updateSplitButton();
}

function clearRanges() {
  rangeList.innerHTML = '';
  ranges = [];
  updateSplitButton();
}

function updateSplitButton() {
  const validRanges = ranges.filter(r => r && r.trim());
  splitBtn.disabled = !pdfDoc || validRanges.length === 0;
}

async function loadPdf(file) {
  if (!file) return;
  
  if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
    alert('Please select a valid PDF file.');
    return;
  }
  
  try {
    updateProgress(0, 'Loading PDF...');
    pdfData = await file.arrayBuffer();
    pdfDoc = await PDFDocument.load(pdfData);
    pageCount = pdfDoc.getPageCount();
    
    // Update UI
    dropZone.classList.add('loaded');
    dropLabel.innerHTML = `‚úÖ <strong>${file.name}</strong> (${pageCount} pages)`;
    rangeSection.style.display = 'block';
    
    // Add initial range
    clearRanges();
    addRange('1-' + pageCount);
    
    hideProgress();
    updateSplitButton();
    
  } catch (err) {
    console.error('Failed to load PDF:', err);
    alert('Failed to load PDF: ' + err.message);
    hideProgress();
  }
}

async function splitPdf() {
  const validRanges = ranges.filter(r => r && r.trim());
  if (!pdfDoc || validRanges.length === 0) return;
  
  try {
    splitBtn.disabled = true;
    const total = validRanges.length;
    
    for (let i = 0; i < total; i++) {
      const rangeStr = validRanges[i];
      const pageIndices = parseRange(rangeStr, pageCount);
      
      if (pageIndices.length === 0) {
        alert(`Range "${rangeStr}" produced no valid pages. Skipping.`);
        continue;
      }
      
      updateProgress(((i + 0.5) / total) * 100, `Creating PDF ${i + 1}/${total}...`);
      
      const newPdf = await PDFDocument.create();
      const pages = await newPdf.copyPages(pdfDoc, pageIndices);
      pages.forEach(page => newPdf.addPage(page));
      
      const pdfBytes = await newPdf.save();
      
      // Download
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // Create descriptive filename with range and page count
      const sanitizedRange = rangeStr.replace(/[^0-9,-]/g, '_').replace(/_+/g, '_');
      a.download = `split-${i + 1}-${pageIndices.length}pages-${sanitizedRange}.pdf`;
      a.click();
      URL.revokeObjectURL(url);
      
      updateProgress(((i + 1) / total) * 100);
    }
    
    updateProgress(100, `Success! Created ${total} PDF file(s)`);
    setTimeout(hideProgress, 3000);
    
  } catch (err) {
    console.error('Split failed:', err);
    alert('Split failed: ' + err.message);
    hideProgress();
  } finally {
    updateSplitButton();
  }
}

// Event handlers
selectBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => loadPdf(e.target.files?.[0]));

dropZone.addEventListener('dragenter', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', (e) => { 
  e.preventDefault(); 
  if (!dropZone.contains(e.relatedTarget)) dropZone.classList.remove('drag-over'); 
});
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  if (e.dataTransfer?.files?.[0]) loadPdf(e.dataTransfer.files[0]);
});

addRangeBtn.addEventListener('click', () => addRange());
splitBtn.addEventListener('click', splitPdf);
clearBtn.addEventListener('click', () => {
  pdfData = null;
  pdfDoc = null;
  pageCount = 0;
  clearRanges();
  rangeSection.style.display = 'none';
  dropZone.classList.remove('loaded');
  dropLabel.innerHTML = 'üìÅ Drop a PDF file here';
  hideProgress();
  updateSplitButton();
});

// Presets
presetAll.addEventListener('click', () => {
  clearRanges();
  for (let i = 1; i <= pageCount; i++) {
    addRange(String(i));
  }
});

presetHalves.addEventListener('click', () => {
  clearRanges();
  const mid = Math.ceil(pageCount / 2);
  addRange(`1-${mid}`);
  if (mid < pageCount) {
    addRange(`${mid + 1}-${pageCount}`);
  }
});

presetOddEven.addEventListener('click', () => {
  clearRanges();
  const odd = [];
  const even = [];
  for (let i = 1; i <= pageCount; i++) {
    if (i % 2 === 1) odd.push(i);
    else even.push(i);
  }
  addRange(odd.join(','));
  if (even.length > 0) addRange(even.join(','));
});
</script>
</body>
</html>
